# 商品系统需求分析

## 一、系统概述

### 1.1 目标
开发一个完整的商品系统，支持后台管理和前端购买功能，为音乐游戏场馆提供额外的商品销售渠道。

### 1.2 用户角色
- **管理员**：商品管理、库存管理、订单管理
- **普通用户**：商品浏览、购买、支付
- **会员用户**：享受会员价格和特权

## 二、功能需求

### 2.1 后台管理功能

#### 2.1.1 商品管理
- **商品增删改查**
  - 新增商品：基本信息、价格、库存、图片等
  - 编辑商品：修改商品信息、价格、库存等
  - 删除商品：逻辑删除和物理删除
  - 查询商品：按分类、名称、状态等条件查询

- **商品分类管理**
  - 商品分类的增删改查
  - 分类层级结构（支持二级分类）
  - 分类状态管理

- **商品状态管理**
  - 上架/下架状态
  - 售罄状态
  - 推荐状态

#### 2.1.2 库存管理
- **库存数量管理**
  - 入库操作：增加库存数量
  - 出库操作：减少库存数量（销售扣减）
  - 库存调整：手动调整库存数量
  - 库存预警：低库存自动提醒

- **库存记录管理**
  - 库存变更历史记录
  - 操作人员记录
  - 变更原因记录
  - 库存统计报表

#### 2.1.3 订单管理
- **订单查询与处理**
  - 按时间、状态、用户等条件查询订单
  - 订单详情查看
  - 订单状态更新（待支付、已支付、已完成等）
  - 订单导出功能

- **退款处理**
  - 退款申请审核
  - 退款金额处理
  - 退款记录管理

#### 2.1.4 商品销售统计
- **销售数据统计**
  - 按商品统计销售额、销量
  - 按分类统计销售情况
  - 按时间段统计销售趋势（日/周/月/年）
  - 热销商品排行榜

- **用户购买分析**
  - 用户购买频次统计
  - 用户消费金额分析
  - 复购率统计
  - ~~会员消费分析~~

- **库存统计**
  - 库存周转率分析
  - 滞销商品统计
  - 库存预警统计
  - 补货建议

- **财务统计**
  - 日/周/月销售额统计
  - 退款金额统计
  - 净收入统计
  - 支付方式统计

### 2.2 前端用户功能

#### 2.2.1 商品展示
- **商品列表**
  - 分类浏览商品
  - 搜索功能（按名称、分类搜索）
  - 排序功能（价格、销量、上架时间）
  - 分页加载

- **商品详情**
  - 商品图片轮播
  - 详细信息展示
  - 价格显示（统一价格）
  - 库存状态显示
  - 购买数量选择

#### 2.2.2 购买流程
- **直接购买**
  - 商品详情页选择数量
  - 立即购买按钮
  - 直接进入下单流程

- **下单流程**
  - 确认订单信息（商品、数量、价格）
  - 选择支付方式
  - 生成订单

#### 2.2.3 权限控制
- **购买权限**
  - 仅限user角色用户可以购买商品
  - 仅限admin角色用户可以购买商品
  - preUser角色用户无法查看和购买商品
  - 未登录用户无法查看商品页面

#### 2.2.4 支付功能
- **支付集成**
  - 集成uni-pay支付系统
  - 支持微信支付
  - 新增"商品购买"支付方式

- **支付状态管理**
  - 支付状态实时更新
  - 支付成功/失败处理
  - 支付超时处理

### 2.3 会员特权（暂不实现）

~~#### 2.3.1 价格优惠~~
- ~~**会员折扣**~~
  - ~~不同会员等级享受不同折扣~~
  - ~~会员专享价格~~
  - ~~会员日活动~~

~~#### 2.3.2 积分系统~~
- ~~**积分获取**~~
  - ~~购物获得积分~~
  - ~~评价获得积分~~
  - ~~推荐获得积分~~

- ~~**积分使用**~~
  - ~~积分抵扣现金~~
  - ~~积分兑换商品~~
  - ~~积分等级制度~~

## 三、数据结构设计

### 3.1 商品表 (products)
```javascript
{
  _id: "ObjectId",                    // 商品ID
  name: "商品名称",                  // 商品名称
  categoryId: "分类ID",              // 分类ID
  description: "商品描述",          // 商品描述
  images: ["图片URL数组"],           // 商品图片
  price: 100,                       // 统一价格（分）
  // memberPrice: 80,              // 会员价（暂不实现）
  stock: 100,                       // 库存数量
  sales: 0,                         // 销量
  status: "onsale",                 // 状态：onsale/offsale/soldout
  isRecommended: false,            // 是否推荐
  sort: 0,                         // 排序权重
  tags: ["标签数组"],               // 商品标签
  specifications: [                 // 规格选项
    {
      name: "颜色",
      options: ["红色", "蓝色"]
    }
  ],
  variants: [                       // SKU变体
    {
      sku: "SKU编码",
      specs: {"颜色": "红色", "尺寸": "M"},
      price: 100,
      stock: 10,
      image: "图片URL"
    }
  ],
  createTime: "timestamp",          // 创建时间
  updateTime: "timestamp",          // 更新时间
  createUser: "用户ID",             // 创建用户
  updateUser: "用户ID"              // 更新用户
}
```

### 3.2 商品分类表 (product_categories)
```javascript
{
  _id: "ObjectId",                  // 分类ID
  name: "分类名称",                // 分类名称
  parentId: "父分类ID",            // 父分类ID（一级分类为null）
  sort: 0,                         // 排序权重
  icon: "图标URL",                 // 分类图标
  status: "active",                // 状态：active/inactive
  description: "分类描述",         // 分类描述
  createTime: "timestamp",         // 创建时间
  updateTime: "timestamp"          // 更新时间
}
```

### 3.3 库存记录表 (inventory_logs)
```javascript
{
  _id: "ObjectId",                 // 记录ID
  productId: "商品ID",             // 商品ID
  variantId: "变体ID",             // 变体ID（可选）
  type: "in/out/adjust",          // 类型：入库/出库/调整
  quantity: 10,                    // 变更数量
  beforeStock: 100,               // 变更前库存
  afterStock: 110,                 // 变更后库存
  reason: "变更原因",             // 变更原因
  operator: "操作人ID",           // 操作人
  orderNo: "关联订单号",          // 关联订单号（出库时）
  createTime: "timestamp",         // 创建时间
  note: "备注信息"                // 备注信息
}
```

### 3.4 商品订单表 (product_orders)
```javascript
{
  _id: "ObjectId",                 // 订单ID
  orderNo: "订单编号",            // 订单编号
  userId: "用户ID",               // 用户ID
  userName: "用户名称",           // 用户名称
  userPhone: "用户电话",          // 用户电话
  items: [                        // 订单商品
    {
      productId: "商品ID",
      variantId: "变体ID",
      productName: "商品名称",
      productImage: "商品图片",
      sku: "SKU编码",
      specs: {"颜色": "红色"},
      price: 100,                 // 商品单价（分）
      quantity: 2,                 // 购买数量
      totalPrice: 200             // 小计（分）
    }
  ],
  totalPrice: 200,                // 订单总金额（分）
  // discountAmount: 0,           // 优惠金额（暂不实现）
  actualAmount: 200,              // 实际支付金额（分）
  // pointsUsed: 0,               // 使用积分（暂不实现）
  // pointsAmount: 0,             // 积分抵扣金额（暂不实现）
  status: "pending",               // 订单状态：pending/paid/completed/refunded
  paymentMethod: "商品购买",       // 支付方式
  paymentNo: "支付单号",         // 支付单号
  paymentTime: "timestamp",      // 支付时间
  remark: "订单备注",             // 订单备注
  createTime: "timestamp",        // 创建时间
  updateTime: "timestamp",        // 更新时间
  refundStatus: "none",          // 退款状态
  refundAmount: 0,               // 退款金额（分）
  refundTime: "timestamp"        // 退款时间
}
```

// 购物车功能已移除，采用直接购买模式

### 3.6 商品销售统计表 (product_statistics)
```javascript
{
  _id: "ObjectId",                 // 统计ID
  productId: "商品ID",            // 商品ID
  productName: "商品名称",         // 商品名称
  categoryId: "分类ID",            // 分类ID
  date: "2024-01-01",            // 统计日期
  orderCount: 10,                 // 订单数量
  totalQuantity: 25,              // 销售总量
  totalAmount: 2500,              // 销售总额（分）
  uv: 15,                         // 访客数
  pv: 30,                         // 访问量
  directPurchaseCount: 20,        // 直接购买次数
  createTime: "timestamp",        // 创建时间
  updateTime: "timestamp"         // 更新时间
}
```

### 3.7 用户消费统计表 (user_consumption_stats)
```javascript
{
  _id: "ObjectId",                 // 统计ID
  userId: "用户ID",               // 用户ID
  userName: "用户名称",           // 用户名称
  orderCount: 5,                  // 总订单数
  totalAmount: 1500,              // 总消费金额（分）
  lastOrderTime: "timestamp",      // 最后购买时间
  // memberLevel: "weekly",        // 会员等级（暂不实现）
  favoriteCategory: "饮料",        // 偏好分类
  avgOrderAmount: 300,            // 平均订单金额（分）
  purchaseFrequency: 2,            // 购买频次（次/月）
  createTime: "timestamp",        // 创建时间
  updateTime: "timestamp"         // 更新时间
}
```

## 四、支付系统集成

### 4.1 uni-pay配置扩展
```javascript
// 在uni-pay配置中添加商品购买支付方式
{
  "mp-weixin": {
    "appid": "微信小程序appid",
    "privateKey": "微信小程序密钥",
    "mchId": "商户号",
    "key": "API密钥",
    "notifyUrl": "支付回调地址"
  },
  // 新增商品购买支付配置
  "product-purchase": {
    "type": "goods",              // 标记为商品购买类型
    "name": "商品购买",           // 显示名称
    "description": "商城商品购买支付"
  }
}
```

### 4.2 支付流程设计
1. **创建订单**：生成商品订单，状态为"待支付"
2. **发起支付**：调用uni-pay创建支付订单，类型为"商品购买"
3. **支付回调**：支付成功后更新订单状态，扣减库存
4. **支付失败**：更新订单状态为"支付失败"
5. **支付超时**：自动关闭订单，恢复库存

## 五、界面设计

### 5.1 后台管理界面
- **商品列表页**：支持搜索、筛选、批量操作
- **商品编辑页**：富文本编辑器、图片上传、规格管理
- **库存管理页**：库存统计、入库出库操作
- **订单管理页**：订单列表、详情查看、状态更新

### 5.2 前端用户界面
- **商品首页**：分类导航、推荐商品、搜索栏
  - 由于商品总数较少（15-20个），可采用网格布局，减少分页加载
  - 分类导航采用标签页形式，便于快速切换
- **商品列表页**：商品展示、筛选排序、分页加载
  - 考虑到商品数量不多，可在一页内展示所有商品
  - 支持按分类筛选和价格排序
- **商品详情页**：商品信息、规格选择、购买按钮
- **订单页面**：订单列表、详情查看

## 六、技术实现要点

### 6.1 数据库设计
- 使用uniCloud NoSQL数据库
- 设计合理的索引提高查询性能
- 考虑数据一致性，特别是在库存扣减时

### 6.2 性能优化
- 商品图片使用CDN加速
- 分页加载避免大量数据查询
- 缓存热门商品数据
- 考虑到商品数量较少（15-20个），可以：
  - 预加载所有商品数据，减少网络请求
  - 使用本地缓存提高访问速度
  - 简化分页逻辑，提升用户体验

### 6.3 安全性考虑
- 支付安全：使用uni-pay官方支付接口
- 数据验证：前后端数据校验
- 权限控制：基于角色的访问控制
  - 商品相关页面访问权限控制
  - 购买操作权限控制
  - 订单查看权限控制
- 防刷机制：防止恶意刷订单

### 6.4 扩展性考虑
- 支持多规格商品
- 支持多种支付方式
- 支持优惠券系统（预留接口）

## 七、开发计划

### 第一阶段：基础功能
1. 商品管理功能
2. 商品展示功能
3. 线下购买结算流程

### 第二阶段：完整功能
1. 支付集成
2. 订单管理
3. 库存管理系统

### 第三阶段：高级功能
1. ~~会员积分系统~~（暂不实现）
2. 数据统计分析
3. 报表导出功能

## 八、风险与挑战

### 8.1 技术风险
- 支付集成复杂度
- 高并发库存管理
- 大量图片存储

### 8.2 业务风险
- 商品数据准确性
- 支付异常处理
- 用户投诉处理
- 库存管理准确性（线下销售同步问题）
- 结算金额核对
- 权限绕过风险
- 恶意订单风险

### 8.3 解决方案
- 充分测试支付流程
- 设计合理的库存管理机制
- 建立完善的客服流程
- 线上线下库存同步机制
- 定期对账功能
- 严格的权限验证机制
- 订单频率限制和异常检测

---

*此需求分析文档为商品系统的初步规划，后续开发过程中可能根据实际情况进行调整和完善。*