# Config页面价格管理逻辑分析

## 1. 整体架构

价格管理功能分为两个主要部分：
- **普通价格管理**：管理场馆的标准价格方案
- **VIP会员价格管理**：管理会员充值价格方案

## 2. 普通价格管理逻辑

### 数据结构（prices表）：
```javascript
{
  _id: "ObjectId",
  weekdays: [1, 2, 3, 4, 5],  // 适用星期（数组格式）
  price: 5,                     // 价格数值
  unit: "元/小时",              // 价格单位
  type: "普通",                 // 价格类型
  description: "",              // 描述信息
  // 其他字段：role, noplayprice, machineId, venueId等
}
```

### 核心功能：

**新增/编辑模式切换**：
- 支持新增价格和编辑现有价格两种模式
- 编辑模式下通过选择器选择要编辑的价格方案

**表单字段**：
- **适用日期**：数组格式，如 `[1, 2, 3, 4, 5]` 表示周一到周五
- **价格**：数值类型，表示具体价格
- **单位**：如 "元/小时"、"元/半小时" 等
- **类型**：如 "普通"、"会员" 等
- **描述**：价格方案的详细描述

**云函数接口**：
- `todo.Prices_Add()` - 添加价格方案
- `todo.Prices_Update()` - 更新价格方案
- `todo.Prices_List()` - 获取价格列表
- `todo.GetPriceDetail()` - 获取价格详情

## 3. VIP会员价格管理逻辑

### 数据结构（prices_vip表）：
```javascript
{
  _id: "ObjectId",
  type: "weekly",                // 会员类型：周卡/月卡/季卡/年卡
  price: 35800,                  // 价格（以分为单位）
  unit: "分",                     // 单位
  description: "周卡会员价格"     // 描述
}
```

### 会员类型选项：
```javascript
const vipTypeOptions = [
  { value: 'weekly', text: '周卡' },
  { value: 'monthly', text: '月卡' },
  { value: 'quarterly', text: '季卡' },
  { value: 'yearly', text: '年卡' }
];
```

### 核心功能：

**表单字段**：
- **会员类型**：通过单选框选择周卡/月卡/季卡/年卡
- **价格（分）**：以分为单位的价格数值
- **单位**：固定为"分"
- **描述**：会员价格描述

**显示处理**：
- 保存时以分为单位存储
- 显示时转换为元：`(price/100).toFixed(2)`

**云函数接口**：
- `todo.AddVipPrices()` - 添加VIP价格
- `todo.VipPrices_Update()` - 更新VIP价格
- `todo.GetVipPrices()` - 获取VIP价格列表
- `todo.GetVipPriceDetail()` - 获取VIP价格详情

## 4. 权限控制

### 前端权限：
- 只有管理员可以访问config页面
- 通过uni-id进行身份验证

### 后端权限：
```javascript
// 普通价格操作权限检查
const authError = authUtils.checkAdminPermission(clientInfo);
// 会员价格操作权限检查
const authError = authUtils.checkAdminPermission(clientInfo);
```

## 5. 数据库操作

### 普通价格操作：
- **增**：`db.collection('prices').add(content)`
- **改**：`db.collection('prices').doc(id).update(updateData)`
- **查**：`db.collection('prices').field({...}).get()`

### VIP价格操作：
- **增**：`dbJQL.collection('prices_vip').add(content)`
- **改**：`db.collection('prices_vip').doc(id).update(updateData)`
- **查**：`db.collection('prices_vip').get()`

## 6. 用户体验设计

**界面特点**：
- 采用玻璃拟态设计风格
- 支持展开/折叠收起
- 表单模式切换动画
- 实时数据刷新
- 错误处理和loading状态

**操作流程**：
1. 选择新增或编辑模式
2. 填写/修改价格信息
3. 提交保存
4. 自动刷新列表显示最新数据

## 7. 相关文件位置

### 前端文件：
- 主页面：`pages/config/config.vue:140-316`
- 样式：`pages/config/config.vue:1546-1582`

### 后端文件：
- 云函数服务：`uniCloud-aliyun/cloudfunctions/todo/services/priceService.js`
- 云函数入口：`uniCloud-aliyun/cloudfunctions/todo/index.obj.js`

### 数据库表结构：
- 普通价格表：`uniCloud-aliyun/database/prices.schema.json`
- VIP价格表：`uniCloud-aliyun/database/prices_vip.schema.json`

## 8. 扩展性考虑

这套价格管理系统设计完整，支持灵活的价格策略配置，适合音乐游戏场馆的复杂定价需求。主要特点：

1. **时间维度**：支持按星期配置不同价格
2. **用户维度**：支持普通用户和会员的差异化定价
3. **机台维度**：可按机台设置不同价格（通过machineId关联）
4. **权限维度**：严格的权限控制确保数据安全

可以根据业务需要进一步扩展，如节假日价格、时段价格等。