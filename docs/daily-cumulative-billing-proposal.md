# å½“æ—¥ç´¯è®¡é¢„çº¦è®¡è´¹ä¼˜åŒ–æ–¹æ¡ˆ

## ðŸ“‹ é—®é¢˜åˆ†æž

### å½“å‰é—®é¢˜
ç”¨æˆ·åœ¨åŒä¸€å¤©è¿›è¡Œåˆ†æ®µé¢„çº¦æ—¶ï¼ŒçŽ°æœ‰è®¡è´¹ç­–ç•¥ä¼šå¯¼è‡´è´¹ç”¨é‡å¤è®¡ç®—ï¼š

**ç¤ºä¾‹åœºæ™¯ï¼š**
- ç”¨æˆ·ä¸Šåˆé¢„çº¦ï¼š3å°æ—¶
- ç”¨æˆ·ä¸‹åˆé¢„çº¦ï¼š5å°æ—¶  
- æ€»æ—¶é•¿ï¼š8å°æ—¶

**å½“å‰è®¡è´¹æ–¹å¼ï¼š**
- ä¸Šåˆï¼šæŒ‰3å°æ—¶è®¡è´¹
- ä¸‹åˆï¼šæŒ‰5å°æ—¶è®¡è´¹
- **æ€»è´¹ç”¨**ï¼š3å°æ—¶è´¹ç”¨ + 5å°æ—¶è´¹ç”¨

**é—®é¢˜**ï¼šè¶…è¿‡5å°æ—¶åº”è¯¥æŒ‰æ•´å¤©è®¡è´¹ï¼Œä½†åˆ†æ®µé¢„çº¦å¯¼è‡´ç”¨æˆ·å¤šä»˜è´¹ç”¨

### çŽ°æœ‰è®¡è´¹é€»è¾‘åˆ†æž

æ ¹æ®ä»£ç åˆ†æžï¼Œå½“å‰è®¡è´¹ç­–ç•¥å¦‚ä¸‹ï¼š

1. **æ™®é€šç”¨æˆ·**ï¼š
   - åŸºç¡€ä»·æ ¼ï¼š5å…ƒ/å•ä½æ—¶é—´
   - è¿‡å¤œä»·æ ¼ï¼š50å…ƒ/æ¬¡

2. **ä¼šå‘˜ç”¨æˆ·**ï¼š
   - åŒ…å‘¨/æœˆå¡ï¼šå…è´¹
   - éŸ³æ¸¸ä¼šå‘˜ï¼š4å…ƒ/åŠå°æ—¶ï¼Œå½“æ—¥å°é¡¶40å…ƒ

3. **è®¡è´¹æ—¶æœº**ï¼š
   - åœ¨åˆ›å»ºé¢„çº¦æ—¶ç‹¬ç«‹è®¡ç®—æ¯æ¬¡è´¹ç”¨
   - æ²¡æœ‰è€ƒè™‘å½“æ—¥ç´¯è®¡æ—¶é•¿

## ðŸŽ¯ è§£å†³æ–¹æ¡ˆè®¾è®¡

### æ–¹æ¡ˆä¸€ï¼šé¢„çº¦æ—¶æ™ºèƒ½åˆå¹¶è®¡è´¹ï¼ˆæŽ¨èï¼‰

#### æ ¸å¿ƒæ€è·¯
åœ¨ç”¨æˆ·åˆ›å»ºæ–°é¢„çº¦æ—¶ï¼Œè‡ªåŠ¨æ£€æŸ¥å½“æ—¥å·²æœ‰é¢„çº¦ï¼Œè¿›è¡Œç´¯è®¡è®¡è´¹ã€‚

#### å®žçŽ°æ­¥éª¤

1. **å½“æ—¥é¢„çº¦æŸ¥è¯¢**
   ```javascript
   // æŸ¥è¯¢ç”¨æˆ·å½“å¤©çš„æ‰€æœ‰æœ‰æ•ˆé¢„çº¦
   async function getUserDayReservations(userId, targetDate) {
     const startOfDay = new Date(targetDate.setHours(0, 0, 0, 0));
     const endOfDay = new Date(targetDate.setHours(23, 59, 59, 999));
     
     return await db.collection('reservation-log').where({
       userId: userId,
       status: 1, // æœ‰æ•ˆé¢„çº¦
       startTime: dbCmd.gte(startOfDay),
       endTime: dbCmd.lte(endOfDay)
     }).get();
   }
   ```

2. **ç´¯è®¡æ—¶é•¿è®¡ç®—**
   ```javascript
   function calculateTotalDuration(existingReservations, newReservation) {
     const allReservations = [...existingReservations, newReservation];
     let totalMinutes = 0;
     
     // åˆå¹¶é‡å æ—¶é—´æ®µå¹¶è®¡ç®—æ€»æ—¶é•¿
     const mergedRanges = mergeTimeRanges(allReservations);
     mergedRanges.forEach(range => {
       totalMinutes += (range.endTime - range.startTime) / (1000 * 60);
     });
     
     return totalMinutes / 60; // è¿”å›žå°æ—¶æ•°
   }
   ```

3. **æ™ºèƒ½è®¡è´¹é€»è¾‘**
   ```javascript
   function calculateSmartPrice(totalHours, userMembership, isOvernight) {
     if (isOvernight) {
       return 50; // è¿‡å¤œå›ºå®šä»·æ ¼
     }
     
     // ä¼šå‘˜è®¡è´¹
     if (userMembership.hasPackage) {
       return 0; // åŒ…å‘¨/æœˆå¡å…è´¹
     }
     
     if (userMembership.isMusicMember) {
       if (totalHours > 5) {
         return 40; // è¶…è¿‡5å°æ—¶æŒ‰å°é¡¶ä»·
       }
       return Math.min(Math.ceil(totalHours * 2) * 4, 40);
     }
     
     // æ™®é€šç”¨æˆ·è®¡è´¹
     if (totalHours > 5) {
       // è¶…è¿‡5å°æ—¶æŒ‰æ•´å¤©è®¡è´¹
       return calculateDailyPrice(totalHours);
     }
     
     // æœªè¶…è¿‡5å°æ—¶æŒ‰æ­£å¸¸è®¡è´¹
     return calculateNormalPrice(totalHours);
   }
   ```

#### ä¼˜åŠ¿
- âœ… å®žæ—¶è®¡ç®—ï¼Œç”¨æˆ·ç«‹å³çœ‹åˆ°ä¼˜æƒ 
- âœ… é¿å…åŽç»­é€€æ¬¾å¤„ç†
- âœ… ç”¨æˆ·ä½“éªŒæ›´å¥½

#### åŠ£åŠ¿
- âŒ éœ€è¦ä¿®æ”¹çŽ°æœ‰é¢„çº¦åˆ›å»ºé€»è¾‘
- âŒ å¢žåŠ é¢„çº¦åˆ›å»ºæ—¶çš„è®¡ç®—å¤æ‚åº¦

### æ–¹æ¡ˆäºŒï¼šäº‹åŽç»“ç®—ä¼˜åŒ–

#### æ ¸å¿ƒæ€è·¯
ä¿æŒçŽ°æœ‰é¢„çº¦åˆ›å»ºé€»è¾‘ï¼Œåœ¨ç»“ç®—æ—¶æ£€æŸ¥å½“æ—¥ç´¯è®¡æ—¶é•¿ï¼Œè¿›è¡Œè´¹ç”¨è°ƒæ•´ã€‚

#### å®žçŽ°æ­¥éª¤

1. **ç»“ç®—æ—¶ç´¯è®¡æ£€æŸ¥**
   ```javascript
   async function smartSettlement(signInId, userId, clientInfo) {
     // 1. èŽ·å–å½“æ—¥æ‰€æœ‰é¢„çº¦
     const dayReservations = await getUserDayReservations(userId, new Date());
     
     // 2. è®¡ç®—ç´¯è®¡æ—¶é•¿
     const totalHours = calculateTotalDuration(dayReservations);
     
     // 3. è®¡ç®—åº”ä»˜è´¹ç”¨
     const shouldPayAmount = calculateSmartPrice(totalHours, userMembership);
     
     // 4. è®¡ç®—å·²ä»˜è´¹ç”¨
     const paidAmount = calculateTotalPaid(dayReservations);
     
     // 5. å¤„ç†å·®é¢ï¼ˆé€€æ¬¾æˆ–è¡¥è´¹ï¼‰
     if (paidAmount > shouldPayAmount) {
       await processRefund(paidAmount - shouldPayAmount);
     }
     
     // 6. å®Œæˆç»“ç®—
     await completeSettlement(signInId, shouldPayAmount);
   }
   ```

#### ä¼˜åŠ¿
- âœ… ä¸å½±å“çŽ°æœ‰é¢„çº¦æµç¨‹
- âœ… å¯ä»¥æ‰¹é‡å¤„ç†
- âœŒï¸ ä¿®æ”¹èŒƒå›´è¾ƒå°

#### åŠ£åŠ¿
- âŒ ç”¨æˆ·éœ€è¦ç­‰å¾…é€€æ¬¾
- âŒ æ¶‰åŠé€€æ¬¾æµç¨‹å¤æ‚
- âŒ ç”¨æˆ·ä½“éªŒç¨å·®

### æ–¹æ¡ˆä¸‰ï¼šæ··åˆæ–¹æ¡ˆï¼ˆæœ€ä¼˜ï¼‰

#### æ ¸å¿ƒæ€è·¯
ç»“åˆæ–¹æ¡ˆä¸€å’Œæ–¹æ¡ˆäºŒçš„ä¼˜ç‚¹ï¼Œå®žçŽ°é¢„æµ‹æ€§è®¡è´¹ + æœ€ç»ˆç»“ç®—è°ƒæ•´ã€‚

#### å®žçŽ°æž¶æž„

1. **é¢„çº¦åˆ›å»ºæ—¶**
   - æ˜¾ç¤ºé¢„è®¡è´¹ç”¨ï¼ˆåŸºäºŽç´¯è®¡æ—¶é•¿é¢„æµ‹ï¼‰
   - æŒ‰å•æ¬¡é¢„çº¦æ”¶è´¹
   - æç¤ºå¯èƒ½çš„è´¹ç”¨ä¼˜æƒ 

2. **æœ€ç»ˆç»“ç®—æ—¶**
   - ç²¾ç¡®è®¡ç®—å½“æ—¥ç´¯è®¡æ—¶é•¿
   - å¤šé€€å°‘è¡¥
   - ç”Ÿæˆè´¹ç”¨æ˜Žç»†

## ðŸ’¡ æŽ¨èå®žæ–½æ–¹æ¡ˆ

åŸºäºŽçŽ°æœ‰ä»£ç æž¶æž„åˆ†æžï¼Œ**æŽ¨èæ–¹æ¡ˆä¸€**ï¼ˆé¢„çº¦æ—¶æ™ºèƒ½åˆå¹¶è®¡è´¹ï¼‰ï¼ŒåŽŸå› å¦‚ä¸‹ï¼š

### æŠ€æœ¯å¯è¡Œæ€§é«˜
- çŽ°æœ‰çš„ `reservationService.addReservation` å‡½æ•°å·²å…·å¤‡å¤æ‚çš„è®¡è´¹é€»è¾‘
- ä¼šå‘˜åˆ¤æ–­é€»è¾‘å·²å®Œæ•´å®žçŽ°
- æ•°æ®åº“æŸ¥è¯¢èƒ½åŠ›æ”¯æŒå½“æ—¥é¢„çº¦æ£€æŸ¥

### ç”¨æˆ·ä½“éªŒæœ€ä½³
- å®žæ—¶æ˜¾ç¤ºä¼˜æƒ åŽçš„è´¹ç”¨
- é¿å…å¤æ‚çš„é€€æ¬¾æµç¨‹
- ç¬¦åˆç”¨æˆ·é¢„æœŸ

### å®žçŽ°æˆæœ¬é€‚ä¸­
- ä¸»è¦ä¿®æ”¹ `addReservation` å‡½æ•°
- éœ€è¦æ–°å¢žæ—¶é—´æ®µåˆå¹¶ç®—æ³•
- ä¸å½±å“ç»“ç®—æµç¨‹

## ðŸ“ å…·ä½“å®žçŽ°è¦ç‚¹

### 1. æ—¶é—´æ®µåˆå¹¶ç®—æ³•
```javascript
function mergeTimeRanges(reservations) {
  // æŒ‰å¼€å§‹æ—¶é—´æŽ’åº
  const sorted = reservations.sort((a, b) => a.startTime - b.startTime);
  const merged = [];
  
  for (const range of sorted) {
    if (merged.length === 0) {
      merged.push(range);
      continue;
    }
    
    const last = merged[merged.length - 1];
    if (range.startTime <= last.endTime) {
      // é‡å æˆ–è¿žç»­ï¼Œåˆå¹¶
      last.endTime = Math.max(last.endTime, range.endTime);
    } else {
      merged.push(range);
    }
  }
  
  return merged;
}
```

### 2. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- ä¸º `startTime` å’Œ `userId` åˆ›å»ºå¤åˆç´¢å¼•
- ä½¿ç”¨ JQL æŸ¥è¯¢æé«˜æ€§èƒ½

### 3. å¹¶å‘å¤„ç†
- æ·»åŠ ä¹è§‚é”é˜²æ­¢é‡å¤é¢„çº¦
- ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

### 4. ç”¨æˆ·æç¤ºä¼˜åŒ–
- åœ¨é¢„çº¦ç•Œé¢æ˜¾ç¤ºå½“æ—¥ç´¯è®¡æ—¶é•¿
- æ˜Žç¡®æ ‡æ³¨è´¹ç”¨ä¼˜æƒ è¯´æ˜Ž
- æä¾›è´¹ç”¨è®¡ç®—æ˜Žç»†

## ðŸ” å½±å“èŒƒå›´è¯„ä¼°

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
1. `uniCloud-aliyun/cloudfunctions/todo/services/reservationService.js`
2. å‰ç«¯é¢„çº¦é¡µé¢ï¼ˆæ˜¾ç¤ºç´¯è®¡æ—¶é•¿å’Œè´¹ç”¨è¯´æ˜Žï¼‰

### æ•°æ®åº“å˜æ›´
- æ— éœ€ç»“æž„å˜æ›´
- å»ºè®®æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

### æµ‹è¯•èŒƒå›´
- åˆ†æ®µé¢„çº¦è®¡è´¹æµ‹è¯•
- ä¼šå‘˜è®¡è´¹æµ‹è¯•
- è¾¹ç•Œæƒ…å†µæµ‹è¯•ï¼ˆè·¨å¤©ã€é‡å ç­‰ï¼‰

## ðŸŽ¯ é¢„æœŸæ•ˆæžœ

### ç”¨æˆ·ä½“éªŒæå‡
- âœ… è´¹ç”¨æ›´å…¬å¹³åˆç†
- âœ… å®žæ—¶çœ‹åˆ°ä¼˜æƒ 
- âœ… é€æ˜ŽåŒ–çš„è®¡è´¹è§„åˆ™

### ä¸šåŠ¡æ•ˆç›Š
- âœ… æé«˜ç”¨æˆ·æ»¡æ„åº¦
- âœ… å‡å°‘è´¹ç”¨äº‰è®®
- âœ… ä¼˜åŒ–è®¡è´¹ç­–ç•¥

---

**æ€»ç»“**ï¼šé€šè¿‡é¢„çº¦æ—¶æ™ºèƒ½åˆå¹¶è®¡è´¹æ–¹æ¡ˆï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³åˆ†æ®µé¢„çº¦å¯¼è‡´çš„é‡å¤è®¡è´¹é—®é¢˜ï¼Œæå‡ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿå…¬å¹³æ€§ã€‚è¯¥æ–¹æ¡ˆæŠ€æœ¯ä¸Šå¯è¡Œï¼Œå®žçŽ°æˆæœ¬åˆç†ï¼ŒæŽ¨èä¼˜å…ˆå®žæ–½ã€‚